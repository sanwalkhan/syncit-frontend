<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Panel and Popup</title>
    <link rel="stylesheet" href="https://icons8.com/icon/118497/facebook">
    <link rel="stylesheet" href="https://img.icons8.com/material-two-tone/20/vertical-line.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>

    </style>
</head>

<body>
    <div class="container me-0 mt-5">
        <div class="row">
            <div class="col-md-6">
                <div class="left-panel d-flex align-items-center justify-content-center flex-column">
                    <div id="stepsContainer" class="step-container">
                        <!-- Initial step -->
                        <div class=" mb-3">
                            <div class="left-panel-box">
                                <button id="connectHubSpot" class="btn btn-secondary trigger-btn">Trigger</button>
                                <ol class="mb-1">
                                    <li>Select the event that starts your zap</li>
                                </ol>
                            </div>
                            <div class="d-flex flex-column align-items-center justify-content-center">
                                <img class="step-icon m-0" width="20" height="20"
                                    src="https://img.icons8.com/material-two-tone/20/vertical-line.png"
                                    alt="vertical-line" />
                                <div class="d-flex flex-column align-items-center justify-content-center">
                                    <button class="btn btn-primary add-step-btn ">+</button>
                                </div>

                            </div>

                            <div class="left-panel-box">
                                <button class="btn btn-secondary trigger-btn">Action</button>
                                <ol class="mb-1">
                                    <li>Select the event that starts your zap</li>
                                </ol>
                            </div>
                            <div class="d-flex flex-column align-items-center justify-content-center">
                                <img class="step-icon m-0" width="20" height="20"
                                    src="https://img.icons8.com/material-two-tone/20/vertical-line.png"
                                    alt="vertical-line" />
                                <div class="d-flex flex-column align-items-center justify-content-center">
                                    <button class="btn btn-primary add-step-btn ">+</button>
                                </div>

                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-2"></div>
            <div class="col-md-4">


                <div id="rightPanelContainer" class="container mt-4" style="display: none;">
                    <div class="right-panel">
                        <!-- Header Section: Close Button and Title -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 id="rightPanelTitle" class="mb-0">1. Select the Event</h5>
                            <button id="closeRightPanelBtn" class="btn btn-sm">X</button>
                        </div>

                        <!-- Step Tracker -->
                        <div class="step-tracker">
                            <div class="step">
                                <span class="step-dot " id="tracker-dot-1"></span>
                                <span class="step-name ms-3" id="tracker-name-1">Setup</span>
                            </div>
                            <div class="step">
                                <span class="step-dot" id="tracker-dot-2"></span>
                                <span class="step-name ms-3" id="tracker-name-2">Configure</span>
                            </div>
                            <div class="step">
                                <span class="step-dot" id="tracker-dot-3"></span>
                                <span class="step-name ms-3" id="tracker-name-3">Test</span>
                            </div>
                        </div>

                        <!-- Step Sections -->
                        <div class="step-section active" id="step-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="w-100">
                                    <label>App</label>
                                    <div class="app-input">
                                        <img id="appIcon" src="https://via.placeholder.com/20" alt="App Icon">
                                        <span id="selectedApp">Google Calendar</span>
                                        <button class="btn btn-link my-2" id="changeAppBtn">Change</button>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 select-event">
                                <label id="selectedEventLabel">Trigger Event</label>
                                <select class="form-select">
                                    <option value="">Choose an event</option>
                                    <option value="event1">Event 1</option>
                                    <option value="event2">Event 2</option>
                                </select>
                            </div>
                            <div class="mt-3 change-account">
                                <label>Account</label>
                                <div>
                                    <input type="text" class="form-control" value="Google Calendar Account" readonly>
                                </div>
                            </div>
                            <div class="buttons mt-auto">
                                <button type="button" class="step-1-btn" onclick="nextStep()">Continue</button>
                            </div>
                        </div>

                        <!-- Step 2 -->
                        <div class="step-section" id="step-2">
                            <label>Drive</label>
                            <div>
                                <input type="text" class="form-control" value="Google Drive" readonly>
                            </div>
                            <div class="buttons">
                                <button type="button" class="right-panel-btn" onclick="prevStep()">Back</button>
                                <button type="button" class="right-panel-btn" onclick="nextStep()">Continue</button>
                            </div>
                        </div>

                        <!-- Step 3 -->
                        <div class="step-section" id="step-3">
                            <h3>Step 3: Test</h3>
                            <label>Account:</label>
                            <input type="text" placeholder="Enter Account">
                            <div class="buttons">
                                <button type="button" class="right-panel-btn" onclick="prevStep()">Back</button>
                                <button type="button" class="right-panel-btn" disabled>Submit</button>
                            </div>
                        </div>
                    </div>
                </div>



            </div>
        </div>

    </div>

    <!-- Popup Template -->
    <div id="popupTemplate" style="display: none;">
        <div class="overlay"></div>
        <div class="popup">
            <h5>Select option to create Zap</h5>
            <ul class="list-group">
                <div class="row">
                    <div class="col-md-6">
                        <li>
                            <p>Your Top Apps</p>
                        </li>
                        <li class=" popup-option">
                            <img width="13" height="13" src="https://img.icons8.com/color/20/google-logo.png"
                                alt="google-logo" />
                            Google
                        </li>
                        <li class="popup-option">
                            <img width="13" height="13" src="https://img.icons8.com/fluency/100/google-calendar--v2.png"
                                alt="google-calendar--v2" />
                            Google Calendar
                        </li>
                        <li class="popup-option">
                            <img width="13" height="13" src="https://img.icons8.com/ios/13/speaker_1.png"
                                alt="speaker_1" />
                            Facebook Lead Ads
                        </li>
                        <li class="popup-option">
                            <img width="13" height="13" src="https://img.icons8.com/color/20/google-drive--v2.png"
                                alt="google-drive--v2" />
                            Google Drive
                        </li>
                        <li class="popup-option">
                            <img width="13" height="13" src="https://img.icons8.com/color/13/gmail-new.png"
                                alt="gmail-new" />
                            Gmail
                        </li>
                        <li class="popup-option">
                            <img width="13" height="13" src="https://img.icons8.com/windows/100/hubspot.png"
                                alt="hubspot" />
                            HubSpot
                        </li>
                        <li class="popup-option">
                            <img width="13" height="13" src="https://img.icons8.com/color/240/google-sheets.png"
                                alt="google-sheets" />
                            Google Sheets
                        </li>
                        <li class="popup-option">
                            <img width="13" height="13" src="https://img.icons8.com/glyph-neue/100/notion.png"
                                alt="notion" />
                            Notion
                        </li>
                        <li class="popup-option">
                            <img width="13" height="13" src="https://img.icons8.com/color/100/slack-new.png"
                                alt="slack-new" />
                            Slack
                        </li>
                        <li class="popup-option">
                            <img width="13" height="13" src="https://img.icons8.com/fluency/13/google-forms.png"
                                alt="google-forms" />
                            Google Forms
                        </li>
                        <li class="popup-option">
                            <img width="13" height="13" src="https://img.icons8.com/stencil/13/c.png" alt="c" />
                            Calendly
                        </li>
                        <li class="popup-option">
                            <img width="13" height="13" src="https://img.icons8.com/ios-glyphs/13/rounded-square.png"
                                alt="rounded-square" />
                            Typeform
                        </li>
                    </div>
                    <div class="col-md-6">
                        <li>
                            <p>popular built-in</p>
                        </li>
                        <li class="popup-option">
                            <img width="13" height="13" src="https://img.icons8.com/windows/13/fan-speed.png"
                                alt="fan-speed" />
                            Webhooks
                        </li>
                        <li class="popup-option">
                            <img width="13" height="13" src="https://img.icons8.com/pastel-glyph/13/overtime--v3.png"
                                alt="overtime--v3" />
                            Schedule
                        </li>
                        <li class="popup-option">
                            <img width="13" height="13"
                                src="https://img.icons8.com/fluency-systems-regular/13/new-post.png" alt="new-post" />
                            Email
                        </li>
                        <li class="popup-option">
                            <img width="13" height="13" src="https://img.icons8.com/color/13/rss.png" alt="rss" />
                            RSS
                        </li>
                        <li class="popup-option">
                            <img width="13" height="13" src="https://img.icons8.com/metro/13/code.png" alt="code" />
                            Code
                        </li>
                        <li class="popup-option">
                            <img width="13" height="13" src="https://img.icons8.com/pulsar-line/13/outbox.png"
                                alt="outbox" />
                            Email Parser
                        </li>
                        <li class="popup-option">
                            <img width="13" height="13" src="https://img.icons8.com/wired/13/folder-tree.png"
                                alt="folder-tree" />
                            Sub-Zap
                        </li>
                        <li class="popup-option">
                            <img width="13" height="13"
                                src="https://img.icons8.com/external-xnimrodx-lineal-xnimrodx/13/external-layer-graphic-design-xnimrodx-lineal-xnimrodx.png"
                                alt="external-layer-graphic-design-xnimrodx-lineal-xnimrodx" />
                            Interfaces
                        </li>
                        <li class="popup-option">
                            <img width="13" height="13"
                                src="https://img.icons8.com/external-xnimrodx-lineal-xnimrodx/13/external-layer-graphic-design-xnimrodx-lineal-xnimrodx.png"
                                alt="external-layer-graphic-design-xnimrodx-lineal-xnimrodx" />
                            Tables
                        </li>
                        <li class="popup-option">
                            <img width="13" height="13"
                                src="https://img.icons8.com/external-xnimrodx-lineal-xnimrodx/13/external-layer-graphic-design-xnimrodx-lineal-xnimrodx.png"
                                alt="external-layer-graphic-design-xnimrodx-lineal-xnimrodx" />
                            Chatbot
                        </li>
                    </div>
                </div>

            </ul>
            <button class="btn btn-danger mt-3 close-popup">X</button>
        </div>
    </div>


    <script>
        // Example API base URL (replace with your actual server URL)
        const API_BASE_URL = "http://localhost:5000/api";

        // Function to verify HubSpot connection
        async function verifyHubSpotConnection(apiKey) {
            try {
                const response = await fetch(`${API_BASE_URL}/hubspot/verify`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ apiKey })
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (error) {
                console.error("Error verifying HubSpot connection:", error);
                alert("Failed to connect to HubSpot.");
            }
        }

        // Function to fetch available events
        async function fetchAvailableEvents() {
            try {
                const response = await fetch(`${API_BASE_URL}/hubspot/events`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json"
                    }
                });

                const result = await response.json();
                if (response.ok) {
                    displayEvents(result.events);
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (error) {
                console.error("Error fetching events:", error);
                alert("Failed to fetch events.");
            }
        }

        // Function to display events in a dropdown or list
        function displayEvents(events) {
            const eventSelect = document.querySelector(".select-event select");
            eventSelect.innerHTML = "<option value=''>Choose an event</option>";
            events.forEach(event => {
                const option = document.createElement("option");
                option.value = event.id;
                option.textContent = event.name;
                eventSelect.appendChild(option);
            });
        }

        // Event listener for "Continue" button in Step 1
        document.querySelector(".step-1-btn").addEventListener("click", async () => {
            const apiKey = prompt("Enter your HubSpot API Key:");
            if (apiKey) {
                await verifyHubSpotConnection(apiKey);
                await fetchAvailableEvents();
                nextStep();
            }
        });

        let currentStep = 1;

        function showStep(step) {
            // Update the visibility of the steps
            document.querySelectorAll(".step-section").forEach((section) => {
                section.classList.remove("active");
            });
            document.getElementById(`step-${step}`).classList.add("active");

            // Update the step tracker
            document.querySelectorAll(".step-dot").forEach((dot, index) => {
                if (index < step) {
                    dot.classList.add("completed");
                } else {
                    dot.classList.remove("completed");
                }
            });

            document.querySelectorAll(".step-name").forEach((name, index) => {
                if (index < step) {
                    name.classList.add("completed");
                } else {
                    name.classList.remove("completed");
                }
            });
        }

        function nextStep() {
            currentStep++;
            if (currentStep > 3) currentStep = 3; // Max steps
            showStep(currentStep);
        }

        function prevStep() {
            currentStep--;
            if (currentStep < 1) currentStep = 1; // Min step
            showStep(currentStep);
        }




        // Attach event listener
        document.getElementById('connectHubSpot').addEventListener('click', connectHubSpot);

        // Function to handle HubSpot connection initiation
        function connectHubSpot() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('Please log in first');
                return;
            }
            // Redirect to backend to start HubSpot OAuth
            window.location.href = `http://localhost:5000/api/hubspot/authorize?token=${token}`;
        }

        // Function to fetch HubSpot contacts after the user is authenticated
        async function fetchContacts() {
            try {
                const authToken = localStorage.getItem('authToken');
                if (!authToken) {
                    alert('No access token found. Please log in.');
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/hubspot/contacts`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}` // Send the token in the request header
                    }
                });

                const data = await response.json();
                if (response.ok) {
                    displayContacts(data.contacts);
                } else {
                    alert('Error fetching contacts');
                }
            } catch (error) {
                console.error('Error fetching contacts:', error);
            }
        }

        // Display contacts on the page
        function displayContacts(contacts) {
            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = contacts.map(contact => `
                <div>
                    <p><strong>Name:</strong> ${contact.firstName} ${contact.lastName}</p>
                    <p><strong>Email:</strong> ${contact.email}</p>
                </div>
            `).join('');
        }

        document.addEventListener('DOMContentLoaded', function () {
            const authorizeButton = document.getElementById('authorize-button');

            authorizeButton.addEventListener('click', function () {
                const authToken = localStorage.getItem('authToken');
                if (!authToken) {
                    alert('No auth token found. Please log in first.');
                    return;
                }

                // Redirect to the backend's authorize endpoint with the token
                window.location.href = `http://localhost:5000/api/hubspot/authorize?token=${authToken}`;
            });

            // Function to handle the callback from HubSpot
            function handleHubSpotCallback() {
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const authToken = localStorage.getItem('authToken');

                if (code && authToken) {
                    sendAuthorizationToBackend(code, authToken);
                }
            }

            // Function to send the authorization code to the backend
            function sendAuthorizationToBackend(code, token) {
                fetch(`http://localhost:5000/api/hubspot/callback?code=${code}&token=${token}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            alert('HubSpot integration successful!');
                        } else {
                            alert(`Error: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error sending authorization to backend:', error);
                        alert('An error occurred during HubSpot integration.');
                    });
            }

            // Check for HubSpot callback when the page loads
            handleHubSpotCallback();
        });
    </script>


</body>

</html>